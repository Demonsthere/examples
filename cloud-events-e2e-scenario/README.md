# Receive Cloud Events from an external solution

This is an example scenario which demonstrates how Kyma can receive Cloud Events from an external solution. To make things easier, this scenario uses a  **local Kyma installation**.

This scenario uses a mocked external solution. You can mock the sending of Events using an HTTP client.
You can also use other mocked or real solutions.
The runtime flow involves following steps:

1. The external solution sends an `order.created` Event.
2. The Event is accepted by Kyma.
3. The Event triggers the deployed lambda.
4. The lambda prints out CE context attributes.

## Prerequisites

### Install Kyma locally

Use these [instructions](https://github.com/kyma-project/kyma/blob/master/docs/kyma/04-02-local-installation.md) to install and configure Kyma locally.

### Create a Namespace

Create a Namespace called `workshop`. You can choose a different name, but remember to use it in the commands.

### Create Application

1. In the Kyma Console, go to **Integration** > **Application** > **Create Application**.
2. Enter the Application name: sample-external-solution. 

## Installation

### Establish secure connection

Use the [connector service](https://github.com/kyma-project/kyma/blob/master/docs/application-connector/02-02-connector-service.md) to establish a secure connection between the mocked external solution and your application.

Follow these steps connect an external solution to Kyma:
1. Clone [this repository](https://github.com/janmedrek/one-click-integration-script).

2. In the Kyma Console, navigate to **Integration** > **Applications** > **sample-external-solution**.
3. Click **Connect Application**.
4. Copy the token.
  
5. Use the one-click-generation [helper script](https://github.com/janmedrek/one-click-integration-script) to generate the certificate:

  ```bash
  ./one-click-integration.sh -u <paste URL here>
  ```

 This script generates a `generated.pem` file. It contains the signed certificate and key that you will use for subsequent communications.

  > **NOTE** The token expires quickly, so use it right away or generate a new one.

### Mock an external solution

Use any HTTP client, such as curl or postman, to send a request from the mocked external solution to Kyma.

### Register Events

1. Register Events via the metadata API using [`register-events.json`](./register-events.json):

    ```bash
    # Using httpie
    http POST https://gateway.kyma.local/sample-external-solution/v1/metadata/services --cert=generated.pem --verify=no < register-events.json
    # Using curl
    curl -X POST -H "Content-Type: application/json" -d @./register-events.json https://gateway.kyma.local/sample-external-solution/v1/metadata/services --cert generated.pem -k
    ```

To verify the Event flow, navigate to **Integration** > **Applications** > **sample-external-solution**. You can see the registered Events.

### Bind Application

1. Navigate to **Integration** > **Applications** > **sample-external-solution**
2. Create a binding with the `workshop` Namespace.

### Add Events and APIs to the Namespace

1. Select the `workshop` Namespace and go to **Service Management** > **Catalog**.
2. Click **Services** to see the registered Events.
3. Click on the Event entry to reveal details.
4. Click **Add once** button to add Events to your Namespace.
5. Go to **Service Instances** > **Services** tab to see if the Events are available.

### Create lambda

1. Create the lambda definition in lambda ui using [lambda.js](./lambda.js) in the workshop namespace

2. Click **Select Function trigger** button to select an Event trigger, then choose
**order.created**.

## Runtime

### Publish the Event

Use the certificate generated by the `./one-click-integration.sh` script to send a Cloud Event to the gateway using any HTTP client, such as curl, httpie, or postman. You can also use CloudEvents SDK. For details, see [this example](./example.go)

## Verification

To check if the lambda function was triggered properly, inspect the Pod logs in the `workshop` Namespace:

```bash
  kubectl -n work logs lambdaname-xxx-xxxx -c lambdaname -f
```

You can also find traces under `https://jaeger.kyma.local/`.
